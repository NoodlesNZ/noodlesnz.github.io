"use strict";(self.webpackChunknoodles=self.webpackChunknoodles||[]).push([[3236],{6896:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>a,contentTitle:()=>s,default:()=>l,frontMatter:()=>r,metadata:()=>d,toc:()=>p});var i=t(5893),o=t(1151);const r={title:"ipv6 workaround for Unifi USG on 2 Degrees UFB"},s=void 0,d={permalink:"/blog/2018/09/20/ipv6-workaround-for-unifi-usg-on-2-degrees-ufb",source:"@site/blog/2018-09-20-ipv6-workaround-for-unifi-usg-on-2-degrees-ufb.mdx",title:"ipv6 workaround for Unifi USG on 2 Degrees UFB",description:"I had an issue where our USG Pro was not getting ipv6 from 2 Degrees UFB after upgrading our Controller to 5.8. After a lot of messing around with this, I found a workaround originally posted here//community.ubnt.com/t5/UniFi-Routing-Switching/USG-DHCPv6-PD-bug-when-using-PPPoE/td-p/2487710.",date:"2018-09-20T00:00:00.000Z",formattedDate:"September 20, 2018",tags:[],readingTime:1.985,hasTruncateMarker:!0,authors:[],frontMatter:{title:"ipv6 workaround for Unifi USG on 2 Degrees UFB"},unlisted:!1,prevItem:{title:"Running Akamai Sandbox in Docker with HTTPS",permalink:"/blog/2018/10/12/running-akamai-sandbox-in-docker-with-https"},nextItem:{title:"Speed up Jenkins phpcs (PHP CodeSniffer)",permalink:"/blog/2015/07/08/speed-up-jenkins-phpcs-php-codesniffer"}},a={authorsImageUrls:[]},p=[];function c(n){const e={a:"a",code:"code",p:"p",pre:"pre",...(0,o.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.p,{children:["I had an issue where our USG Pro was not getting ipv6 from 2 Degrees UFB after upgrading our Controller to 5.8. After a lot of messing around with this, I found a workaround originally posted here: ",(0,i.jsx)(e.a,{href:"https://community.ubnt.com/t5/UniFi-Routing-Switching/USG-DHCPv6-PD-bug-when-using-PPPoE/td-p/2487710",children:"https://community.ubnt.com/t5/UniFi-Routing-Switching/USG-DHCPv6-PD-bug-when-using-PPPoE/td-p/2487710"}),"."]}),"\n","\n",(0,i.jsx)(e.p,{children:"Digging into the dhcpv6-pd logs shows this:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"admin@SecurityGateway:~$ show dhcpv6-pd log\nSep/12/2018 08:14:08: dhcp6_ctl_init: bind(control sock): Address already in use\nSep/12/2018 08:14:08: client6_init: failed to initialize control channel\n"})}),"\n",(0,i.jsx)(e.p,{children:"Dumping out the config I saw that I had two dhcpv6-pd blocks, one under interface eth2 vif 10 and the other under interface eth2 vif 10 pppoe 2 (where it should be):"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'mca-ctrl -t dump-cfg\n\n"eth2": {\n    "description": "WAN",\n    "vif": {\n            "10": {\n                    "description": "WAN",\n                    "dhcpv6-pd": {\n                            "pd": {\n                                    "0": {\n                                            "interface": {\n                                                    "eth0": "\'\'"\n                                            },\n                                            "prefix-length": "56"\n                                    }\n                            },\n                            "rapid-commit": "enable"\n                    },\n                    "firewall": {\n                            "in": {\n                                    "ipv6-name": "WANv6_IN",\n                                    "name": "WAN_IN"\n                            },\n                            "local": {\n                                    "ipv6-name": "WANv6_LOCAL",\n                                    "name": "WAN_LOCAL"\n                            },\n                            "out": {\n                                    "ipv6-name": "WANv6_OUT",\n                                    "name": "WAN_OUT"\n                            }\n                    },\n                    "pppoe": {\n                            "2": {\n                                    "default-route": "none",\n                                    "dhcpv6-pd": {\n                                            "pd": {\n                                                    "0": {\n                                                            "interface": {\n                                                                    "eth0": "\'\'"\n                                                            },\n                                                            "prefix-length": "56"\n                                                    }\n                                            },\n                                            "rapid-commit": "enable"\n                                    },\n                                    "firewall": {\n                                            "in": {\n                                                    "ipv6-name": "WANv6_IN",\n                                                    "name": "WAN_IN"\n                                            },\n                                            "local": {\n                                                    "ipv6-name": "WANv6_LOCAL",\n                                                    "name": "WAN_LOCAL"\n                                            },\n                                            "out": {\n                                                    "ipv6-name": "WANv6_OUT",\n                                                    "name": "WAN_OUT"\n                                            }\n                                    },\n                                    "ipv6": {\n                                            "address": "autoconf",\n                                            "enable": "\'\'"\n                                    },\n                                    "name-server": "none",\n                                    "password": "<password>",\n                                    "user-id": "<username>"\n                            }\n                    }\n            }\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"It was possible to temporarily fix this issue by removing the first block:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"configure\ndelete interfaces ethernet eth2 vif 10 dhcpv6-pd\ncommit\nexit\n\nrelease dhcpv6-pd interface pppoe2\ndelete dhcpv6-pd duid\nrenew dhcpv6-pd interface pppoe2\n"})}),"\n",(0,i.jsx)(e.p,{children:"This allowed our USG to get ipv6 from our ISP and now all the clients on the network also got ipv6."}),"\n",(0,i.jsxs)(e.p,{children:["To make this more permanent I had to add this file on the USG under ",(0,i.jsx)(e.code,{children:"/config/scripts/post-config.d/dhcp.sh"})]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'#!/bin/vbash\n\nreadonly logFile="/var/log/postprovision.log"\n\nsource /opt/vyatta/etc/functions/script-template\n\nconfigure > ${logFile}\n\ndelete system task-scheduler task postprovision >> ${logFile}\n\ndelete interfaces ethernet eth2 vif 10 dhcpv6-pd >> ${logFile}\ncommit\nexit\n\nrelease dhcpv6-pd interface pppoe2 >> ${logFile}\ndelete dhcpv6-pd duid  >> ${logFile}\nrenew dhcpv6-pd interface pppoe2 >> ${logFile}\n'})}),"\n",(0,i.jsxs)(e.p,{children:["To run this script, I added the following on the Controller in ",(0,i.jsx)(e.code,{children:"/usr/lib/unifi/data/sites/default/config.gateway.json"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'{\n    "system":{\n        "task-scheduler":{\n            "task":{\n                "postprovision":{\n                    "executable":{\n                        "path":"/config/scripts/post-config.d/dhcp.sh"\n                    },\n                    "interval":"2m"\n                }\n            }\n        }\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"This runs the dhcp.sh script 2 minutes after provisioning and then the script removes the scheduled task (as it only needs to run once)."})]})}function l(n={}){const{wrapper:e}={...(0,o.a)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(c,{...n})}):c(n)}},1151:(n,e,t)=>{t.d(e,{Z:()=>d,a:()=>s});var i=t(7294);const o={},r=i.createContext(o);function s(n){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:s(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);